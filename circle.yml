machine:
  services:
    - docker

dependencies:
  override:
    - ./download-meshes

test:
  override:
    - >
        docker run
        -v $(pwd):/home/fenics/fenapack
        -w /home/fenics/fenapack
        quay.io/fenicsproject/dev
        "
        python -c'import ffc, dolfin; print(ffc.git_commit_hash(), ffc.ufc_signature(), dolfin.git_commit_hash())';
        export PYTHONPATH=\$PWD:\$PYTHONPATH;

        py.test test/unit -sv;
        ((rc+=\$?));

        mpirun -n 2 py.test test/unit -sv;
        ((rc+=\$?));

        py.test test/bench -sv;
        ((rc+=\$?));

        cd test/regression;
        NP=2 python -u test.py;
        ((rc+=\$?));

        exit \$rc
        "
  post:
    - mv *.pdf $CIRCLE_ARTIFACTS
