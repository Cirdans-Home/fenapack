<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>PCD preconditioner for Navier-Stokes equations &#8212; FENaPack 2017.1.0.dev0 documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2017.1.0.dev0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="fenapack package" href="../api-doc/fenapack.html" />
    <link rel="prev" title="FENaPack - FEniCS Navier-Stokes preconditioning package" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../api-doc/fenapack.html" title="fenapack package"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../index.html" title="FENaPack - FEniCS Navier-Stokes preconditioning package"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">FENaPack 2017.1.0.dev0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="pcd-preconditioner-for-navier-stokes-equations">
<h1>PCD preconditioner for Navier-Stokes equations<a class="headerlink" href="#pcd-preconditioner-for-navier-stokes-equations" title="Permalink to this headline">¶</a></h1>
<p>This demo is implemented in a single Python file,
<a class="reference download internal" href="../_downloads/demo_navier-stokes-pcd.py" download=""><code class="xref download docutils literal"><span class="pre">demo_navier-stokes-pcd.py</span></code></a>,
which contains both the variational forms and the solver.</p>
<div class="section" id="underlying-mathematics">
<h2>Underlying mathematics<a class="headerlink" href="#underlying-mathematics" title="Permalink to this headline">¶</a></h2>
<p>See <a class="reference internal" href="../index.html#math-background"><span class="std std-ref">Mathematical background</span></a>.</p>
</div>
<div class="section" id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p><strong>Only features beyond standard FEniCS usage will be explained
in this document.</strong></p>
<p>Here comes an artificial boundary condition for PCD operators. Zero Dirichlet
condition for Laplacian solve is applied either on inlet or outlet, depending
on the variant of PCD. Note that it is defined on pressure subspace of the
mixed space <code class="docutils literal"><span class="pre">W</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Artificial BC for PCD preconditioner</span>
<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">pcd_variant</span> <span class="o">==</span> <span class="s2">&quot;BRM1&quot;</span><span class="p">:</span>
    <span class="n">bc_pcd</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">boundary_markers</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">pcd_variant</span> <span class="o">==</span> <span class="s2">&quot;BRM2&quot;</span><span class="p">:</span>
    <span class="n">bc_pcd</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">boundary_markers</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Then comes standard formulation of the nonlinear equation</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Arguments and coefficients of the form</span>
<span class="n">u</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">TrialFunctions</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="n">v</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">TestFunctions</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="n">u_</span><span class="p">,</span> <span class="n">p_</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<span class="n">nu</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">viscosity</span><span class="p">)</span>

<span class="c1"># Nonlinear equation</span>
<span class="n">F</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">nu</span><span class="o">*</span><span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u_</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">inner</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u_</span><span class="p">),</span> <span class="n">u_</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">-</span> <span class="n">p_</span><span class="o">*</span><span class="n">div</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="n">div</span><span class="p">(</span><span class="n">u_</span><span class="p">)</span>
<span class="p">)</span><span class="o">*</span><span class="n">dx</span>
</pre></div>
</div>
<p>We will provide a possibility to mock Newton solver into Picard iteration by
passing Oseen linearization as Jacobian <code class="docutils literal"><span class="pre">J</span></code></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Jacobian</span>
<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nls</span> <span class="o">==</span> <span class="s2">&quot;picard&quot;</span><span class="p">:</span>
    <span class="n">J</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">nu</span><span class="o">*</span><span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="o">+</span> <span class="n">inner</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">u_</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">div</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="n">div</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="p">)</span><span class="o">*</span><span class="n">dx</span>
<span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">nls</span> <span class="o">==</span> <span class="s2">&quot;newton&quot;</span><span class="p">:</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</pre></div>
</div>
<p>&#8220;Preconditioner&#8221; Jacobian <code class="docutils literal"><span class="pre">J_pc</span></code> features added streamline diffusion
to stabilize 00-block if algebraic multigrid is used. Otherwise we can
pass <code class="docutils literal"><span class="pre">None</span></code> as a precoditioner Jacobian to use the system matrix for
preparing the preconditioner.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Add stabilization for AMG 00-block</span>
<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ls</span> <span class="o">==</span> <span class="s2">&quot;iterative&quot;</span><span class="p">:</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">StabilizationParameterSD</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">nu</span><span class="p">)</span>
    <span class="n">J_pc</span> <span class="o">=</span> <span class="n">J</span> <span class="o">+</span> <span class="n">delta</span><span class="o">*</span><span class="n">inner</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">u_</span><span class="p">),</span> <span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">u_</span><span class="p">))</span><span class="o">*</span><span class="n">dx</span>
<span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">ls</span> <span class="o">==</span> <span class="s2">&quot;direct&quot;</span><span class="p">:</span>
    <span class="n">J_pc</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
</div>
<p><span class="math">\(L^2\)</span> scalar product (&#8220;mass matrix&#8221;) <code class="docutils literal"><span class="pre">mp</span></code>, convection operator <code class="docutils literal"><span class="pre">kp</span></code>,
and Laplacian <code class="docutils literal"><span class="pre">ap</span></code> to be used by <code class="xref any docutils literal"><span class="pre">PCD</span> <span class="pre">BRM</span> <span class="pre">preconditioner</span></code> are defined using pressure components
<code class="docutils literal"><span class="pre">p</span></code>, <code class="docutils literal"><span class="pre">q</span></code> on the mixed space <code class="docutils literal"><span class="pre">W</span></code>. They are passed to the class
<a class="reference internal" href="../api-doc/fenapack.html#fenapack.nonlinear_solvers.PCDProblem" title="fenapack.nonlinear_solvers.PCDProblem"><code class="xref py py-class docutils literal"><span class="pre">fenapack.nonlinear_solvers.PCDProblem</span></code></a> which takes care of
assembling the operators on demand.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># PCD operators</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">dx</span>
<span class="n">kp</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">u_</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">dx</span>
<span class="n">ap</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">q</span><span class="p">))</span><span class="o">*</span><span class="n">dx</span>
<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">pcd_variant</span> <span class="o">==</span> <span class="s2">&quot;BRM2&quot;</span><span class="p">:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">FacetNormal</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">Measure</span><span class="p">(</span><span class="s2">&quot;ds&quot;</span><span class="p">,</span> <span class="n">subdomain_data</span><span class="o">=</span><span class="n">boundary_markers</span><span class="p">)</span>
    <span class="n">kp</span> <span class="o">-=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">u_</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">ds</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Collect forms to define nonlinear problem</span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">PCDProblem</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="p">[</span><span class="n">bc0</span><span class="p">,</span> <span class="n">bc1</span><span class="p">],</span> <span class="n">J</span><span class="p">,</span> <span class="n">J_pc</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="n">ap</span><span class="p">,</span> <span class="n">kp</span><span class="o">=</span><span class="n">kp</span><span class="p">,</span> <span class="n">mp</span><span class="o">=</span><span class="n">mp</span><span class="p">,</span> <span class="n">bcs_pcd</span><span class="o">=</span><span class="n">bc_pcd</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we create GMRES preconditioned with PCD, set the tolerance, enable
monitoring of residual during Krylov iterarations, and set the maximal
dimension of Krylov subspaces.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Set up linear solver (GMRES with right preconditioning using Schur fact)</span>
<span class="n">linear_solver</span> <span class="o">=</span> <span class="n">PCDKrylovSolver</span><span class="p">(</span><span class="n">comm</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">mpi_comm</span><span class="p">())</span>
<span class="n">linear_solver</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;relative_tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
<span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;ksp_monitor&quot;</span><span class="p">)</span>
<span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;ksp_gmres_restart&quot;</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
</pre></div>
</div>
<p>Next we choose a variant of PCD according to a parameter value</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Set up subsolvers</span>
<span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_pc_python_type&quot;</span><span class="p">,</span> <span class="s2">&quot;fenapack.PCDPC_&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">pcd_variant</span><span class="p">)</span>
</pre></div>
</div>
<p>00-block solve and PCD Laplacian solve can be performed using algebraic
multigrid</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ls</span> <span class="o">==</span> <span class="s2">&quot;iterative&quot;</span><span class="p">:</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_u_ksp_type&quot;</span><span class="p">,</span> <span class="s2">&quot;richardson&quot;</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_u_ksp_max_it&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_u_pc_type&quot;</span><span class="p">,</span> <span class="s2">&quot;hypre&quot;</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_u_pc_hypre_type&quot;</span><span class="p">,</span> <span class="s2">&quot;boomeramg&quot;</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Ap_ksp_type&quot;</span><span class="p">,</span> <span class="s2">&quot;richardson&quot;</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Ap_ksp_max_it&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Ap_pc_type&quot;</span><span class="p">,</span> <span class="s2">&quot;hypre&quot;</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Ap_pc_hypre_type&quot;</span><span class="p">,</span> <span class="s2">&quot;boomeramg&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>PCD mass matrix solve can be efficiently performed using Chebyshev iteration
preconditioned by Jacobi method. The eigenvalue estimates come from <a class="footnote-reference" href="#id2" id="id1">[1]</a>,
Lemma 4.3. <strong>Don&#8217;t forget to change them appropriately when changing
dimension/element. Neglecting this can lead to substantially worse
convergence rates.</strong></p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Mp_ksp_type&quot;</span><span class="p">,</span> <span class="s2">&quot;chebyshev&quot;</span><span class="p">)</span>
<span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Mp_ksp_max_it&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Mp_ksp_chebyshev_eigenvalues&quot;</span><span class="p">,</span> <span class="s2">&quot;0.5, 2.0&quot;</span><span class="p">)</span>
<span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Mp_pc_type&quot;</span><span class="p">,</span> <span class="s2">&quot;jacobi&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The direct solver is used by default if the aforementioned blocks
are not executed. FEnaPack tries to pick MUMPS by default and following
parameter enables very verbose output.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">ls</span> <span class="o">==</span> <span class="s2">&quot;direct&quot;</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">mumps_debug</span><span class="p">:</span>
    <span class="c1"># Debugging MUMPS</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_u_mat_mumps_icntl_4&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Ap_mat_mumps_icntl_4&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Mp_mat_mumps_icntl_4&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Let the linear solver use the options</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Apply options</span>
<span class="n">linear_solver</span><span class="o">.</span><span class="n">set_from_options</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally we invoke a Newton solver modification suitable to be used used
with PCD solver.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Set up nonlinear solver</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">PCDNewtonSolver</span><span class="p">(</span><span class="n">linear_solver</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;relative_tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-5</span>

<span class="c1"># Solve problem</span>
<span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">vector</span><span class="p">())</span>
</pre></div>
</div>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Elman H. C., Silvester D. J., Wathen A. J., <em>Finite Elements and Fast
Iterative Solvers: With Application in Incompressible Fluid Dynamics</em>.
Oxford University Press 2005. 2nd edition 2014.</td></tr>
</tbody>
</table>
</div>
<div class="section" id="complete-code">
<h2>Complete code<a class="headerlink" href="#complete-code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span>
<span class="kn">from</span> <span class="nn">dolfin</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span>

<span class="kn">from</span> <span class="nn">fenapack</span> <span class="k">import</span> <span class="n">PCDKrylovSolver</span>
<span class="kn">from</span> <span class="nn">fenapack</span> <span class="k">import</span> <span class="n">PCDNewtonSolver</span>
<span class="kn">from</span> <span class="nn">fenapack</span> <span class="k">import</span> <span class="n">PCDProblem</span>
<span class="kn">from</span> <span class="nn">fenapack</span> <span class="k">import</span> <span class="n">StabilizationParameterSD</span>

<span class="kn">import</span> <span class="nn">argparse</span><span class="o">,</span> <span class="nn">sys</span>

<span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;form_compiler&quot;</span><span class="p">][</span><span class="s2">&quot;representation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;uflacs&quot;</span>
<span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;form_compiler&quot;</span><span class="p">][</span><span class="s2">&quot;optimize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;plotting_backend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;matplotlib&quot;</span>

<span class="c1"># Parse input arguments</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span>
                                 <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-l&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;level of mesh refinement&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--nu&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;viscosity&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;kinematic viscosity&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--pcd&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;pcd_variant&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;BRM2&quot;</span><span class="p">,</span>
                    <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;BRM1&quot;</span><span class="p">,</span> <span class="s2">&quot;BRM2&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;PCD variant&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--nls&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;nls&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;picard&quot;</span><span class="p">,</span>
                    <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;picard&quot;</span><span class="p">,</span> <span class="s2">&quot;newton&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;nonlinear solver&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ls&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;ls&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;iterative&quot;</span><span class="p">,</span>
                    <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;direct&quot;</span><span class="p">,</span> <span class="s2">&quot;iterative&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;linear solvers&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--dm&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;mumps_debug&quot;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;debug MUMPS&quot;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<span class="c1"># Load mesh from file and refine uniformly</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">Mesh</span><span class="p">(</span><span class="s2">&quot;../../data/step_domain.xml.gz&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">level</span><span class="p">):</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">refine</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

<span class="c1"># Define and mark boundaries</span>
<span class="k">class</span> <span class="nc">Gamma0</span><span class="p">(</span><span class="n">SubDomain</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">on_boundary</span>
<span class="k">class</span> <span class="nc">Gamma1</span><span class="p">(</span><span class="n">SubDomain</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">on_boundary</span> <span class="ow">and</span> <span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Gamma2</span><span class="p">(</span><span class="n">SubDomain</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">on_boundary</span> <span class="ow">and</span> <span class="n">near</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">5.0</span><span class="p">)</span>
<span class="n">boundary_markers</span> <span class="o">=</span> <span class="n">FacetFunction</span><span class="p">(</span><span class="s2">&quot;size_t&quot;</span><span class="p">,</span> <span class="n">mesh</span><span class="p">)</span>
<span class="n">boundary_markers</span><span class="o">.</span><span class="n">set_all</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>        <span class="c1"># interior facets</span>
<span class="n">Gamma0</span><span class="p">()</span><span class="o">.</span><span class="n">mark</span><span class="p">(</span><span class="n">boundary_markers</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># no-slip facets</span>
<span class="n">Gamma1</span><span class="p">()</span><span class="o">.</span><span class="n">mark</span><span class="p">(</span><span class="n">boundary_markers</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># inlet facets</span>
<span class="n">Gamma2</span><span class="p">()</span><span class="o">.</span><span class="n">mark</span><span class="p">(</span><span class="n">boundary_markers</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># outlet facets</span>

<span class="c1"># Build Taylor-Hood function space</span>
<span class="n">P2</span> <span class="o">=</span> <span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;Lagrange&quot;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">P1</span> <span class="o">=</span> <span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;Lagrange&quot;</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">P2</span><span class="o">*</span><span class="n">P1</span><span class="p">)</span>

<span class="c1"># No-slip BC</span>
<span class="n">bc0</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">boundary_markers</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Parabolic inflow BC</span>
<span class="n">inflow</span> <span class="o">=</span> <span class="n">Expression</span><span class="p">((</span><span class="s2">&quot;4.0*x[1]*(1.0 - x[1])&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0&quot;</span><span class="p">),</span> <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">bc1</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">inflow</span><span class="p">,</span> <span class="n">boundary_markers</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Artificial BC for PCD preconditioner</span>
<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">pcd_variant</span> <span class="o">==</span> <span class="s2">&quot;BRM1&quot;</span><span class="p">:</span>
    <span class="n">bc_pcd</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">boundary_markers</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">pcd_variant</span> <span class="o">==</span> <span class="s2">&quot;BRM2&quot;</span><span class="p">:</span>
    <span class="n">bc_pcd</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">boundary_markers</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Provide some info about the current problem</span>
<span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reynolds number: Re = </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="n">args</span><span class="o">.</span><span class="n">viscosity</span><span class="p">))</span>
<span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dimension of the function space: </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">W</span><span class="o">.</span><span class="n">dim</span><span class="p">())</span>

<span class="c1"># Arguments and coefficients of the form</span>
<span class="n">u</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">TrialFunctions</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="n">v</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">TestFunctions</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="c1"># FIXME: Which split is correct? Both work but one might use</span>
<span class="c1"># restrict_as_ufc_function</span>
<span class="n">u_</span><span class="p">,</span> <span class="n">p_</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<span class="c1">#u_, p_ = w.split()</span>
<span class="n">nu</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">viscosity</span><span class="p">)</span>

<span class="c1"># Nonlinear equation</span>
<span class="n">F</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">nu</span><span class="o">*</span><span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u_</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">inner</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u_</span><span class="p">),</span> <span class="n">u_</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
    <span class="o">-</span> <span class="n">p_</span><span class="o">*</span><span class="n">div</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="n">div</span><span class="p">(</span><span class="n">u_</span><span class="p">)</span>
<span class="p">)</span><span class="o">*</span><span class="n">dx</span>

<span class="c1"># Jacobian</span>
<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nls</span> <span class="o">==</span> <span class="s2">&quot;picard&quot;</span><span class="p">:</span>
    <span class="n">J</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">nu</span><span class="o">*</span><span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="o">+</span> <span class="n">inner</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">u_</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">p</span><span class="o">*</span><span class="n">div</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">q</span><span class="o">*</span><span class="n">div</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="p">)</span><span class="o">*</span><span class="n">dx</span>
<span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">nls</span> <span class="o">==</span> <span class="s2">&quot;newton&quot;</span><span class="p">:</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">derivative</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

<span class="c1"># Add stabilization for AMG 00-block</span>
<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ls</span> <span class="o">==</span> <span class="s2">&quot;iterative&quot;</span><span class="p">:</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">StabilizationParameterSD</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">nu</span><span class="p">)</span>
    <span class="n">J_pc</span> <span class="o">=</span> <span class="n">J</span> <span class="o">+</span> <span class="n">delta</span><span class="o">*</span><span class="n">inner</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">u_</span><span class="p">),</span> <span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">u_</span><span class="p">))</span><span class="o">*</span><span class="n">dx</span>
<span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">ls</span> <span class="o">==</span> <span class="s2">&quot;direct&quot;</span><span class="p">:</span>
    <span class="n">J_pc</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># PCD operators</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">dx</span>
<span class="n">kp</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">u_</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">dx</span>
<span class="n">ap</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">q</span><span class="p">))</span><span class="o">*</span><span class="n">dx</span>
<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">pcd_variant</span> <span class="o">==</span> <span class="s2">&quot;BRM2&quot;</span><span class="p">:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">FacetNormal</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">Measure</span><span class="p">(</span><span class="s2">&quot;ds&quot;</span><span class="p">,</span> <span class="n">subdomain_data</span><span class="o">=</span><span class="n">boundary_markers</span><span class="p">)</span>
    <span class="n">kp</span> <span class="o">-=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">dot</span><span class="p">(</span><span class="n">u_</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">ds</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#kp -= Constant(1.0/nu)*dot(u_, n)*p*q*ds(0)  # TODO: Is this beneficial?</span>

<span class="c1"># Collect forms to define nonlinear problem</span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">PCDProblem</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="p">[</span><span class="n">bc0</span><span class="p">,</span> <span class="n">bc1</span><span class="p">],</span> <span class="n">J</span><span class="p">,</span> <span class="n">J_pc</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="n">ap</span><span class="p">,</span> <span class="n">kp</span><span class="o">=</span><span class="n">kp</span><span class="p">,</span> <span class="n">mp</span><span class="o">=</span><span class="n">mp</span><span class="p">,</span> <span class="n">bcs_pcd</span><span class="o">=</span><span class="n">bc_pcd</span><span class="p">)</span>

<span class="c1"># Set up linear solver (GMRES with right preconditioning using Schur fact)</span>
<span class="n">linear_solver</span> <span class="o">=</span> <span class="n">PCDKrylovSolver</span><span class="p">(</span><span class="n">comm</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">mpi_comm</span><span class="p">())</span>
<span class="n">linear_solver</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;relative_tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-6</span>
<span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;ksp_monitor&quot;</span><span class="p">)</span>
<span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;ksp_gmres_restart&quot;</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>

<span class="c1"># Set up subsolvers</span>
<span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_pc_python_type&quot;</span><span class="p">,</span> <span class="s2">&quot;fenapack.PCDPC_&quot;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">pcd_variant</span><span class="p">)</span>
<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ls</span> <span class="o">==</span> <span class="s2">&quot;iterative&quot;</span><span class="p">:</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_u_ksp_type&quot;</span><span class="p">,</span> <span class="s2">&quot;richardson&quot;</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_u_ksp_max_it&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_u_pc_type&quot;</span><span class="p">,</span> <span class="s2">&quot;hypre&quot;</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_u_pc_hypre_type&quot;</span><span class="p">,</span> <span class="s2">&quot;boomeramg&quot;</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Ap_ksp_type&quot;</span><span class="p">,</span> <span class="s2">&quot;richardson&quot;</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Ap_ksp_max_it&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Ap_pc_type&quot;</span><span class="p">,</span> <span class="s2">&quot;hypre&quot;</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Ap_pc_hypre_type&quot;</span><span class="p">,</span> <span class="s2">&quot;boomeramg&quot;</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Mp_ksp_type&quot;</span><span class="p">,</span> <span class="s2">&quot;chebyshev&quot;</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Mp_ksp_max_it&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Mp_ksp_chebyshev_eigenvalues&quot;</span><span class="p">,</span> <span class="s2">&quot;0.5, 2.0&quot;</span><span class="p">)</span>
    <span class="c1">#PETScOptions.set(&quot;fieldsplit_p_PCD_Mp_ksp_chebyshev_esteig&quot;, &quot;1,0,0,1&quot;)  # FIXME: What does it do?</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Mp_pc_type&quot;</span><span class="p">,</span> <span class="s2">&quot;jacobi&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">ls</span> <span class="o">==</span> <span class="s2">&quot;direct&quot;</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">mumps_debug</span><span class="p">:</span>
    <span class="c1"># Debugging MUMPS</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_u_mat_mumps_icntl_4&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Ap_mat_mumps_icntl_4&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">PETScOptions</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;fieldsplit_p_PCD_Mp_mat_mumps_icntl_4&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Apply options</span>
<span class="n">linear_solver</span><span class="o">.</span><span class="n">set_from_options</span><span class="p">()</span>

<span class="c1"># Set up nonlinear solver</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">PCDNewtonSolver</span><span class="p">(</span><span class="n">linear_solver</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;relative_tolerance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-5</span>

<span class="c1"># Solve problem</span>
<span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">vector</span><span class="p">())</span>

<span class="c1"># Report timings</span>
<span class="n">list_timings</span><span class="p">(</span><span class="n">TimingClear_clear</span><span class="p">,</span> <span class="p">[</span><span class="n">TimingType_wall</span><span class="p">,</span> <span class="n">TimingType_user</span><span class="p">])</span>

<span class="c1"># Plot solution</span>
<span class="n">u</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;velocity&quot;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;pressure&quot;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;pressure&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;warp&quot;</span><span class="p">)</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">PCD preconditioner for Navier-Stokes equations</a><ul>
<li><a class="reference internal" href="#underlying-mathematics">Underlying mathematics</a></li>
<li><a class="reference internal" href="#implementation">Implementation</a></li>
<li><a class="reference internal" href="#complete-code">Complete code</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../index.html"
                        title="previous chapter">FENaPack - FEniCS Navier-Stokes preconditioning package</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../api-doc/fenapack.html"
                        title="next chapter">fenapack package</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/demos/navier-stokes-pcd.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../api-doc/fenapack.html" title="fenapack package"
             >next</a> |</li>
        <li class="right" >
          <a href="../index.html" title="FENaPack - FEniCS Navier-Stokes preconditioning package"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">FENaPack 2017.1.0.dev0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Jan Blechta, Martin Řehoř.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.5.
    </div>
  </body>
</html>